import{d as $,z as B,q as z,A,c as u,b as d,w as f,h as p,x as h,r as v,o as i,a as y,g as C,F as k,s as V,f as K,v as U,l as D,p as F,E as L,j,y as q,t as x,_ as P}from"./index-CfQAt1pw.js";import{c as Y}from"./stomp-CNIB9Rbl.js";const G={class:"manual-consult"},H={class:"toolbar"},J={class:"chat"},O={key:0,class:"empty"},Q={key:1,class:"messages"},R={class:"bubble"},W={class:"time"},X={key:0,class:"input-row"},Z=$({__name:"ManualConsult",setup(ee){const w=p([]),a=p(null),_=p([]),c=p(""),m=p(!1);let n=null,l=null;async function g(){const t=await h("/patient/consult/sessions");w.value=t??[]}async function r(){const t=a.value;if(!t){_.value=[];return}const s=await h(`/patient/consult/sessions/${t}/messages`);_.value=s??[],l==null||l.unsubscribe(),l=null,n!=null&&n.connected&&(l=n.subscribe(`/topic/consult/${t}`,()=>{r(),g()}))}function N(t){return t?new Date(t).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):""}function S(){a.value=null,_.value=[],c.value=""}async function b(){var s;const t=(s=c.value)==null?void 0:s.trim();if(!(!t||m.value)){m.value=!0;try{const o=await F("/patient/consult/send",{sessionId:a.value||void 0,content:t});c.value="",a.value=o.sessionId,await g(),await r()}catch(o){L.error((o==null?void 0:o.message)??"发送失败")}finally{m.value=!1}}}return B(()=>{g(),n=Y(),n.onConnect=()=>{a.value&&r()},n.activate()}),z(a,t=>{t&&r()}),A(()=>{l==null||l.unsubscribe(),n==null||n.deactivate()}),(t,s)=>{const o=v("el-button"),T=v("el-option"),M=v("el-select"),E=v("el-input"),I=v("el-card");return i(),u("div",G,[d(I,null,{default:f(()=>[y("div",H,[d(o,{type:"primary",onClick:S},{default:f(()=>[...s[2]||(s[2]=[C("新咨询",-1)])]),_:1}),d(M,{modelValue:a.value,"onUpdate:modelValue":s[0]||(s[0]=e=>a.value=e),placeholder:"选择会话",clearable:"",filterable:"",style:{width:"240px","margin-left":"12px"},onChange:r},{default:f(()=>[(i(!0),u(k,null,V(w.value,e=>(i(),j(T,{key:e.id,label:`#${e.id} ${e.status} ${e.patientName||""}`,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),y("div",J,[a.value?(i(),u("div",Q,[(i(!0),u(k,null,V(_.value,e=>(i(),u("div",{key:e.id,class:q(["msg",e.senderType==="PATIENT"?"user":e.senderType==="SYSTEM"?"sys":"doctor"])},[y("div",R,x(e.content),1),y("div",W,x(N(e.createdAt)),1)],2))),128))])):(i(),u("div",O,"点击「新咨询」发起咨询，或选择已有会话。医生认领后可回复并开药。"))]),a.value?(i(),u("div",X,[d(E,{modelValue:c.value,"onUpdate:modelValue":s[1]||(s[1]=e=>c.value=e),type:"textarea",rows:2,placeholder:"输入消息...",onKeydown:K(U(b,["ctrl"]),["enter"])},null,8,["modelValue","onKeydown"]),d(o,{type:"primary",loading:m.value,onClick:b},{default:f(()=>[...s[3]||(s[3]=[C("发送",-1)])]),_:1},8,["loading"])])):D("",!0)]),_:1})])}}}),ae=P(Z,[["__scopeId","data-v-f63a8eaa"]]);export{ae as default};
