import{d as B,u as K,q as L,c as d,b as g,w as C,r as b,o as u,a as h,F as M,s as R,f as U,v as j,g as F,h as w,x as E,E as J,y as W,t as I,_ as q}from"./index-CfQAt1pw.js";const P={class:"ai-consult"},G={class:"chat"},H={key:0,class:"empty"},Q={key:1,class:"messages"},X={class:"bubble"},Y={class:"time"},Z={class:"input-row"},ee=B({__name:"AiConsult",setup(te){const o=w(null),i=w([]),f=w(""),p=w(!1),N=K();L(o,async e=>{if(!e){i.value=[];return}const t=await E(`/ai/sessions/${e}/messages`);i.value=t??[]});function V(e){return e?new Date(e).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):""}async function S(){var t;const e=(t=f.value)==null?void 0:t.trim();if(!(!e||p.value)){p.value=!0;try{const s=new Date().toISOString();i.value.push({id:`u-${Date.now()}`,sender:"USER",content:e,createdAt:s});const m={id:`a-${Date.now()}`,sender:"AI",content:"",createdAt:s};i.value.push(m);const v=N.tokenValue(),_=await fetch("/api/ai/consult/stream",{method:"POST",headers:{"Content-Type":"application/json",...v?{Authorization:v}:{}},body:JSON.stringify({sessionId:o.value||void 0,content:e})});if(!_.ok||!_.body)throw new Error(`请求失败(${_.status})`);f.value="";const D=_.body.getReader(),T=new TextDecoder("utf-8");let c="";const $=a=>{if(a.event==="meta"){try{const r=JSON.parse(a.data);r!=null&&r.sessionId&&(o.value=r.sessionId)}catch{}return}if(a.event==="delta"){m.content+=a.data;return}if(a.event==="error")throw new Error(a.data||"AI stream error")};for(;;){const{value:a,done:r}=await D.read();if(r)break;c+=T.decode(a,{stream:!0});let y;for(;(y=c.indexOf(`

`))!==-1;){const O=c.slice(0,y);c=c.slice(y+2);const z=O.split(`
`).map(l=>l.trimEnd());let k;const x=[];for(const l of z)l.startsWith("event:")&&(k=l.slice(6).trim()),l.startsWith("data:")&&x.push(l.slice(5).trimStart());const A=x.join(`
`);A&&$({event:k,data:A})}}o.value&&(i.value=await E(`/ai/sessions/${o.value}/messages`))}catch(s){J.error((s==null?void 0:s.message)??"发送失败")}finally{p.value=!1}}}return(e,t)=>{const s=b("el-input"),m=b("el-button"),v=b("el-card");return u(),d("div",P,[g(v,null,{default:C(()=>[h("div",G,[o.value?(u(),d("div",Q,[(u(!0),d(M,null,R(i.value,n=>(u(),d("div",{key:n.id,class:W(["msg",n.sender==="USER"?"user":"ai"])},[h("div",X,I(n.content),1),h("div",Y,I(V(n.createdAt)),1)],2))),128))])):(u(),d("div",H,"发起新会话：在下方输入症状或问题，发送给 AI 获取建议。"))]),h("div",Z,[g(s,{modelValue:f.value,"onUpdate:modelValue":t[0]||(t[0]=n=>f.value=n),type:"textarea",rows:2,placeholder:"描述症状或问题...",onKeydown:U(j(S,["ctrl"]),["enter"])},null,8,["modelValue","onKeydown"]),g(m,{type:"primary",loading:p.value,onClick:S},{default:C(()=>[...t[1]||(t[1]=[F("发送",-1)])]),_:1},8,["loading"])])]),_:1})])}}}),ae=q(ee,[["__scopeId","data-v-704fea7e"]]);export{ae as default};
