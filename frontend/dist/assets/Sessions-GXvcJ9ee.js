import{d as ee,z as le,x as I,q as te,c as _,b as l,w as a,h as u,r as d,o as v,g as i,t as U,a as y,F as M,s as A,f as ae,v as ne,l as oe,p as D,E as g,y as se,j as ue,_ as de}from"./index-CfQAt1pw.js";import{c as ie}from"./stomp-CNIB9Rbl.js";const re={class:"sessions"},ce={class:"refresh"},pe={key:0,class:"chat-dialog"},me={class:"chat-messages"},fe={class:"bubble"},ve={class:"time"},_e={class:"chat-input"},ye={class:"actions"},ge=ee({__name:"Sessions",setup(be){const B=u("waiting"),E=u([]),F=u([]),V=u(!1),m=u(null),z=u([]),w=u(""),k=u(!1),b=u(!1),$=u(!1),K=u([]),c=u({diagnosis:"",items:[{drugId:null,quantity:1,dosage:"",frequency:""}]});let r=null,f=null;function S(n){return n?new Date(n).toLocaleString("zh-CN"):""}async function C(){E.value=await I("/doctor/consult/waiting")??[]}async function N(){F.value=await I("/doctor/consult/sessions")??[]}async function j(n){try{await D(`/doctor/consult/claim/${n}`),g.success("认领成功"),C(),N()}catch(e){g.error((e==null?void 0:e.message)??"认领失败")}}async function h(n){z.value=await I(`/doctor/consult/sessions/${n}/messages`)??[]}function W(n){m.value=n,V.value=!0,h(n.id),f==null||f.unsubscribe(),f=null,r!=null&&r.connected&&(f=r.subscribe(`/topic/consult/${n.id}`,()=>h(n.id)))}async function L(){var e;const n=(e=w.value)==null?void 0:e.trim();if(!(!n||!m.value||k.value)){k.value=!0;try{await D("/doctor/consult/send",{sessionId:m.value.id,content:n}),w.value="",h(m.value.id)}catch(o){g.error((o==null?void 0:o.message)??"发送失败")}finally{k.value=!1}}}function Y(){m.value&&(c.value={diagnosis:"",items:[{drugId:null,quantity:1,dosage:"",frequency:""}]},b.value=!0)}async function G(){const n=c.value.items.filter(e=>e.drugId!=null);if(!n.length){g.warning("请至少添加一种药品");return}$.value=!0;try{await D("/doctor/prescriptions",{sessionId:m.value.id,diagnosis:c.value.diagnosis,items:n.map(e=>({drugId:e.drugId,quantity:e.quantity,dosage:e.dosage,frequency:e.frequency}))}),g.success("处方已开具"),b.value=!1,h(m.value.id),N()}catch(e){g.error((e==null?void 0:e.message)??"开具失败")}finally{$.value=!1}}return le(()=>{C(),N(),I("/doctor/drugs").then(n=>{K.value=n??[]}),r=ie(),r.onConnect=()=>{r==null||r.subscribe("/topic/new-consult",()=>C())},r.activate()}),te(V,n=>{n||f==null||f.unsubscribe()}),(n,e)=>{const o=d("el-table-column"),p=d("el-button"),O=d("el-table"),P=d("el-tab-pane"),H=d("el-tabs"),x=d("el-input"),R=d("el-dialog"),T=d("el-form-item"),J=d("el-option"),Q=d("el-select"),X=d("el-input-number"),Z=d("el-form");return v(),_("div",re,[l(H,{modelValue:B.value,"onUpdate:modelValue":e[0]||(e[0]=t=>B.value=t)},{default:a(()=>[l(P,{label:"待认领",name:"waiting"},{default:a(()=>[l(O,{data:E.value,stripe:""},{default:a(()=>[l(o,{prop:"id",label:"会话ID",width:"100"}),l(o,{prop:"patientName",label:"患者"}),l(o,{prop:"createdAt",label:"创建时间",width:"180"},{default:a(({row:t})=>[i(U(S(t.createdAt)),1)]),_:1}),l(o,{label:"操作",width:"120"},{default:a(({row:t})=>[l(p,{type:"primary",link:"",onClick:q=>j(t.id)},{default:a(()=>[...e[7]||(e[7]=[i("认领",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),y("div",ce,[l(p,{onClick:C},{default:a(()=>[...e[8]||(e[8]=[i("刷新",-1)])]),_:1})])]),_:1}),l(P,{label:"我的会话",name:"mine"},{default:a(()=>[l(O,{data:F.value,stripe:""},{default:a(()=>[l(o,{prop:"id",label:"会话ID",width:"100"}),l(o,{prop:"patientName",label:"患者"}),l(o,{prop:"status",label:"状态",width:"120"}),l(o,{prop:"updatedAt",label:"更新时间",width:"180"},{default:a(({row:t})=>[i(U(S(t.updatedAt)),1)]),_:1}),l(o,{label:"操作",width:"140"},{default:a(({row:t})=>[l(p,{type:"primary",link:"",onClick:q=>W(t)},{default:a(()=>[...e[9]||(e[9]=[i("聊天/开药",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})]),_:1},8,["modelValue"]),l(R,{modelValue:V.value,"onUpdate:modelValue":e[2]||(e[2]=t=>V.value=t),title:"会话",width:"640","close-on-click-modal":!1,"destroy-on-close":""},{default:a(()=>[m.value?(v(),_("div",pe,[y("div",me,[(v(!0),_(M,null,A(z.value,t=>(v(),_("div",{key:t.id,class:se(["msg",t.senderType==="DOCTOR"?"me":t.senderType==="SYSTEM"?"sys":"other"])},[y("div",fe,U(t.content),1),y("div",ve,U(S(t.createdAt)),1)],2))),128))]),y("div",_e,[l(x,{modelValue:w.value,"onUpdate:modelValue":e[1]||(e[1]=t=>w.value=t),type:"textarea",rows:2,placeholder:"回复患者...",onKeydown:ae(ne(L,["ctrl"]),["enter"])},null,8,["modelValue","onKeydown"]),y("div",ye,[l(p,{type:"primary",loading:k.value,onClick:L},{default:a(()=>[...e[10]||(e[10]=[i("发送",-1)])]),_:1},8,["loading"]),l(p,{type:"success",loading:$.value,onClick:Y},{default:a(()=>[...e[11]||(e[11]=[i("开处方",-1)])]),_:1},8,["loading"])])])])):oe("",!0)]),_:1},8,["modelValue"]),l(R,{modelValue:b.value,"onUpdate:modelValue":e[6]||(e[6]=t=>b.value=t),title:"开具处方",width:"560","destroy-on-close":""},{default:a(()=>[l(Z,{ref:"rxFormRef",model:c.value,"label-width":"100px"},{default:a(()=>[l(T,{label:"诊断"},{default:a(()=>[l(x,{modelValue:c.value.diagnosis,"onUpdate:modelValue":e[3]||(e[3]=t=>c.value.diagnosis=t),type:"textarea",rows:2,placeholder:"诊断结论"},null,8,["modelValue"])]),_:1}),l(T,{label:"药品"},{default:a(()=>[(v(!0),_(M,null,A(c.value.items,(t,q)=>(v(),_("div",{key:q,class:"rx-row"},[l(Q,{modelValue:t.drugId,"onUpdate:modelValue":s=>t.drugId=s,placeholder:"选择药品",filterable:"",style:{width:"200px"}},{default:a(()=>[(v(!0),_(M,null,A(K.value,s=>(v(),ue(J,{key:s.id,label:`${s.name} ${s.spec}`,value:s.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue"]),l(X,{modelValue:t.quantity,"onUpdate:modelValue":s=>t.quantity=s,min:1,max:99,style:{width:"100px"}},null,8,["modelValue","onUpdate:modelValue"]),l(x,{modelValue:t.dosage,"onUpdate:modelValue":s=>t.dosage=s,placeholder:"用法",style:{width:"120px"}},null,8,["modelValue","onUpdate:modelValue"]),l(x,{modelValue:t.frequency,"onUpdate:modelValue":s=>t.frequency=s,placeholder:"频次",style:{width:"100px"}},null,8,["modelValue","onUpdate:modelValue"]),l(p,{link:"",type:"danger",onClick:s=>c.value.items.splice(q,1)},{default:a(()=>[...e[12]||(e[12]=[i("删",-1)])]),_:1},8,["onClick"])]))),128)),l(p,{type:"primary",link:"",onClick:e[4]||(e[4]=t=>c.value.items.push({drugId:null,quantity:1,dosage:"",frequency:""}))},{default:a(()=>[...e[13]||(e[13]=[i("+ 添加药品",-1)])]),_:1})]),_:1}),l(T,null,{default:a(()=>[l(p,{type:"primary",onClick:G},{default:a(()=>[...e[14]||(e[14]=[i("提交处方",-1)])]),_:1}),l(p,{onClick:e[5]||(e[5]=t=>b.value=!1)},{default:a(()=>[...e[15]||(e[15]=[i("取消",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),ke=de(ge,[["__scopeId","data-v-b12009da"]]);export{ke as default};
